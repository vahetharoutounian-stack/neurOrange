<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>neurOrange — iPhone-locked (smooth ping-pong video & reliable paintings)</title>
<style>
  :root{
    --quin:#ED6A00; --pure:#FFA500; --bergamot:#FFA64D; --nick:#FF6600;
    --gap-deg: 3deg;                  /* separator width (deg) */
    --inner-thick: 34px;              /* px (set at runtime) */
    --outer-thick-mult: 2.2;          /* outer thickness = inner * mult */
    --mid-move-duration: 2200ms;
    --glow: 0 0 10px #000, 0 0 18px #000;
  }

  *{box-sizing:border-box}
  html,body{
    margin:0; height:100%; background:#000; color:#fff;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    -webkit-font-smoothing: antialiased; overflow:hidden;
  }

  /* Full-bleed canvas locked to viewport; layout also recomputed in px */
  #phone{ position:fixed; inset:0; width:100dvw; height:100dvh; display:grid; place-items:center; background:#000; }
  #canvas{ position:relative; width:100%; height:100%; overflow:hidden; background:#000; }

  /* Z: brand(6) → question(5) → mid(3) → inner(2.5) → outer(2) → bg(1) */
  #brandBar{
    position:absolute; left:env(safe-area-inset-left); right:env(safe-area-inset-right);
    top:calc(env(safe-area-inset-top) + 10px);
    display:flex; justify-content:center; z-index:6;
    opacity:1; transform:none;               /* always visible */
    filter: drop-shadow(var(--glow));
  }
  #brand{ font-weight:900; letter-spacing:.12em; font-size:clamp(18px,5vw,32px);
          animation: brandPulse 4s ease-in-out infinite; }
  @keyframes brandPulse{ 0%{color:var(--quin)} 50%{color:var(--pure)} 100%{color:var(--quin)} }

  /* Background: keep visible; no flicker; fog under video with circular mask */
  #bgLayer{ position:absolute; inset:0; z-index:1; opacity:1; }
  #bgVideo{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; background:#000; }
  #tapToPlay{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    z-index:2; color:#fff; background:rgba(0,0,0,.42);
    padding:.4rem .6rem; border-radius:.6rem; font-size:clamp(12px,3.5vw,14px);
    backdrop-filter: blur(4px); display:none;
  }
  .fogWrap{
    position:absolute; inset:-30%; z-index:0; pointer-events:none;
    -webkit-mask-image: radial-gradient(circle at 50% 50%, rgba(0,0,0,1) 62%, rgba(0,0,0,0) 100%);
            mask-image: radial-gradient(circle at 50% 50%, rgba(0,0,0,1) 62%, rgba(0,0,0,0) 100%);
  }
  .fog{
    position:absolute; inset:0; mix-blend-mode:screen; filter: blur(60px) saturate(120%);
    background:
      radial-gradient(28% 22% at 20% 30%, var(--nick) 0 55%, transparent 60%),
      radial-gradient(28% 24% at 80% 40%, var(--nick) 0 55%, transparent 60%),
      radial-gradient(30% 22% at 40% 70%, var(--nick) 0 55%, transparent 60%);
    animation:fog1 26s linear infinite alternate; opacity:.62;
  }
  @keyframes fog1{ 0%{transform:translate(0,0) scale(1)} 100%{transform:translate(-3%,-4%) scale(1.08)} }

  #focus{ position:absolute; inset:0; display:grid; place-items:center; z-index:2 }

  /* Center wrapper for rings (concentric) */
  .wrapCenter{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); }
  .spin{ position:absolute; inset:0; }

  /* Center bubble */
  #question{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%) scale(.9);
    display:grid; place-items:center; background:#000; color:#fff; border-radius:50%;
    border:2px solid #000; z-index:5; filter:drop-shadow(var(--glow));
    padding:.4rem .6rem;
  }
  #questionText{
    font-weight:900; font-style:italic; text-align:center;
    font-size:clamp(16px,3.6vw,22px); line-height:1.15; margin:0;
    animation: breathe 3.8s ease-in-out infinite, tintPulse 3.2s ease-in-out infinite
  }
  @keyframes breathe{ 0%,100%{ transform:scale(.95) } 50%{ transform:scale(1.02) } }
  @keyframes tintPulse{ 0%{color:var(--bergamot)} 50%{color:var(--quin)} 100%{color:var(--bergamot)} }

  /* INNER ring (CW; transparent gaps) */
  #innerWrap{ } /* width/height set by JS */
  #innerSpin{ animation:spinCW 60s linear infinite; filter:drop-shadow(var(--glow)) }
  @keyframes spinCW{ from{ transform: rotate(0deg) } to{ transform: rotate(360deg) } }
  #innerSurface{
    position:absolute; inset:0; border-radius:50%;
    -webkit-mask: radial-gradient(circle,
      transparent calc(50% - var(--inner-thick)),
      #000       calc(50% - var(--inner-thick)),
      #000       calc(50% + var(--inner-thick)),
      transparent calc(50% + var(--inner-thick)));
            mask: radial-gradient(circle,
      transparent calc(50% - var(--inner-thick)),
      #000       calc(50% - var(--inner-thick)),
      #000       calc(50% + var(--inner-thick)),
      transparent calc(50% + var(--inner-thick)));
  }

  /* MID nodes (CCW) */
  #midWrap{ } /* size = innerD; set by JS */
  #midSpin{ animation:spinCCW 56s linear infinite; filter:drop-shadow(var(--glow)) }
  @keyframes spinCCW{ from{ transform: rotate(0deg) } to{ transform: rotate(-360deg) } }
  #midRing{ position:absolute; inset:0 }
  .mnode{
    position:absolute; top:50%; left:50%; width:40px; height:40px; border-radius:50%;
    overflow:hidden; background:#111; border:3px solid #000; box-shadow:0 0 0 2px #000;
    transform:translate(-50%,-50%); filter:drop-shadow(var(--glow));
  }
  .mnode img{ width:100%; height:100%; object-fit:cover; display:block; border-radius:50%;
              animation: upright 56s linear infinite }
  @keyframes upright{ from{ transform: rotate(0deg) } to{ transform: rotate(360deg) } }
  .mnode.noimg{ background: radial-gradient(60% 54% at 50% 42%, #444 0%, #222 60%, #000 100%); }

  /* OUTER color ring (CW; thicker; transparent gaps) */
  #outerWrap{ } /* size set by JS */
  #outerSpin{ animation:spinCW 70s linear infinite }
  #outerSurface{ position:absolute; inset:0; border-radius:50% }
</style>
</head>
<body>
  <div id="phone">
    <div id="canvas">

      <div id="brandBar"><div id="brand">neurOrange</div></div>

      <div id="bgLayer">
        <video id="bgVideo" muted playsinline webkit-playsinline preload="auto"></video>
        <div id="tapToPlay">Tap to play video</div>
        <div class="fogWrap"><div class="fog"></div></div>
      </div>

      <div id="focus">
        <!-- OUTER color ring -->
        <div id="outerWrap" class="wrapCenter">
          <div id="outerSpin" class="spin"><div id="outerSurface" aria-hidden="true"></div></div>
        </div>

        <!-- INNER color ring -->
        <div id="innerWrap" class="wrapCenter">
          <div id="innerSpin" class="spin"><div id="innerSurface" aria-hidden="true"></div></div>
        </div>

        <!-- MID painting nodes -->
        <div id="midWrap" class="wrapCenter">
          <div id="midSpin" class="spin"><div id="midRing" aria-hidden="true"></div></div>
        </div>

        <!-- Center text -->
        <div id="question"><div id="questionText">What are you<br/>feeling?</div></div>
      </div>

    </div>
  </div>

<script>
/* ---------- Palettes ---------- */
const ORANGE_LIBRARY={
  ghosts:[{hex:"#B36019"},{hex:"#F9751F"},{hex:"#F6B76F"},{hex:"#D2B379"},{hex:"#E3AC47"},{hex:"#F88E10"},{hex:"#C18514"},{hex:"#DE9513"},{hex:"#92752D"},{hex:"#F0CE85"},{hex:"#FCBA45"},{hex:"#D99621"},{hex:"#E8C569"},{hex:"#F0B85F"},{hex:"#D2B265"}],
  standards:[{hex:"#F4C430"},{hex:"#FFBF00"},{hex:"#FCC200"},{hex:"#F28500"},{hex:"#FD5E53"},{hex:"#E25822"},{hex:"#FFA500"},{hex:"#D99058"},{hex:"#E87D0D"},{hex:"#FF7F24"},{hex:"#C76A1F"},{hex:"#CB6D51"},{hex:"#FF7F50"},{hex:"#FF8E00"},{hex:"#D07A2D"}],
  food:[{hex:"#ED9121"},{hex:"#FBCEB1"},{hex:"#F28500"},{hex:"#FFA64D"},{hex:"#FF7518"},{hex:"#F6A200"},{hex:"#F98B00"},{hex:"#FFA500"},{hex:"#F99E1A"},{hex:"#E67E22"},{hex:"#F6A700"},{hex:"#DE7C00"},{hex:"#E67910"},{hex:"#FF8A00"},{hex:"#EC5800"}]
};
/* ---------- helpers ---------- */
const gdeg=()=>parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--gap-deg'))||3;
const conicWithGaps=(cols,g,gapColor)=>{const seg=360/cols.length,parts=[];for(let i=0;i<cols.length;i++){const s=i*seg,ce=s+(seg-g),ge=s+seg;parts.push(`${cols[i]} ${s}deg ${ce}deg`,`${gapColor} ${ce}deg ${ge}deg`)}return `conic-gradient(${parts.join(',')})`};
const ghostFirst=n=>{const g=ORANGE_LIBRARY.ghosts.map(x=>x.hex),s=ORANGE_LIBRARY.standards.map(x=>x.hex);const out=g.slice(0,n);let i=0;while(out.length<n)out.push(s[i++%s.length]);return out}
const foodPalette=n=>{const f=ORANGE_LIBRARY.food.map(x=>x.hex);const out=[];let i=0;while(out.length<n)out.push(f[i++%f.length]);return out}

/* ---------- question bubble ---------- */
function sizeQuestion(){
  const b=document.getElementById('question'), t=document.getElementById('questionText');
  const prev=b.style.transform; b.style.transform='translate(-50%,-50%) scale(1)';
  const w=t.offsetWidth, h=t.offsetHeight, pad=Math.max(4,Math.round(Math.max(w,h)*0.02));
  const D=Math.ceil(Math.max(w,h)+pad*2); b.style.width=D+'px'; b.style.height=D+'px';
  b.style.transform=prev||'translate(-50%,-50%) scale(0.90)';
}

/* ---------- paintings loader (robust; cache-buster; case variants) ---------- */
function buildMidNodes(){
  const mid=document.getElementById('midRing'); mid.innerHTML='';
  const exts = ['.jpg','.jpeg','.png','.JPG','.JPEG','.PNG'];
  for(let i=1;i<=6;i++){
    const n=document.createElement('div'); n.className='mnode';
    const img=new Image(); img.alt='Painting';
    n.appendChild(img); mid.appendChild(n);

    let k=0; const stamp='?v='+Date.now();
    (function tryNext(){
      if(k>=exts.length){ n.classList.add('noimg'); return; }
      const src = `assets/paintings/${i}${exts[k++]}${stamp}`;
      img.onerror = tryNext;
      img.decoding = 'async'; img.loading='eager';
      img.src = src;
    })();
  }
}

/* ---------- layout all (concentric, Safari-locked) ---------- */
function layoutAll(){
  const root=document.documentElement, canvas=document.getElementById('canvas');
  const innerWrap=document.getElementById('innerWrap'), innerSurface=document.getElementById('innerSurface');
  const midWrap=document.getElementById('midWrap'),  midRing=document.getElementById('midRing');
  const outerWrap=document.getElementById('outerWrap'), outerSurface=document.getElementById('outerSurface');

  const W=window.innerWidth, H=window.innerHeight, S=Math.min(W,H);
  canvas.style.width=W+'px'; canvas.style.height=H+'px';

  /* inner ring geometry */
  const innerD=Math.round(S*0.58), innerThick=Math.max(16,Math.round(innerD*0.12));
  innerWrap.style.width=innerWrap.style.height=innerD+'px';
  root.style.setProperty('--inner-thick', innerThick+'px');
  innerSurface.style.background = conicWithGaps(foodPalette(12), gdeg(), 'transparent');

  /* mid nodes radius so outer edges touch left/right screen edges */
  midWrap.style.width=midWrap.style.height=innerD+'px';
  const nodeD=Math.round(innerThick*0.85*5.25), margin=2, midR=Math.max(0,(W/2)-(nodeD/2)-margin);
  const nodes=midRing.querySelectorAll('.mnode'); const N=6, step=2*Math.PI/N;
  nodes.forEach((n,i)=>{ const a=i*step, x=Math.cos(a)*midR, y=Math.sin(a)*midR;
    n.style.width=n.style.height=nodeD+'px';
    n.style.transform=`translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`; });

  /* outer ring geometry */
  const outerInnerR = midR + nodeD/2 + margin;
  const outerThick  = innerThick * (parseFloat(getComputedStyle(root).getPropertyValue('--outer-thick-mult'))||2.2);
  const outerOuterR = Math.max(outerInnerR + outerThick, W/2 + 8);
  const outD = Math.round(outerOuterR*2);
  outerWrap.style.width=outerWrap.style.height=outD+'px';

  const mask=`radial-gradient(circle, transparent ${outerInnerR}px, #000 ${outerInnerR}px, #000 ${outerOuterR}px, transparent ${outerOuterR}px)`;
  outerSurface.style.webkitMask=mask; outerSurface.style.mask=mask;
  outerSurface.style.background = conicWithGaps(ghostFirst(18), gdeg(), 'transparent');
}

/* ---------- smooth ping-pong video (with fallback) ---------- */
(function pingPongVideo(){
  const v=document.getElementById('bgVideo'), tap=document.getElementById('tapToPlay');

  // Set src only once (prevents brief flash if not found)
  const src = 'assets/placeholder.mp4';
  v.src = src;

  let dir = 1;                 // 1 = forward, -1 = reverse
  let rafId = null, rafMode = false;
  const fps = 60, stepBase = 1/fps; // seconds/frame

  function cancelRAF(){ if(rafId){ cancelAnimationFrame(rafId); rafId=null; } }

  function stepRAF(){
    const step = stepBase * 1.0 * (dir);     // speed=1.0x
    v.currentTime = Math.max(0, Math.min(v.duration, v.currentTime + step));
    if(v.currentTime >= v.duration - 0.03){ dir = -1; }
    if(v.currentTime <= 0.03){ dir =  1; }
    rafId = requestAnimationFrame(stepRAF);
  }

  function tryReversePlaybackRate(){
    // Attempt negative playbackRate; detect if Safari actually moves time backward
    return new Promise(resolve=>{
      if(!isFinite(v.duration) || v.duration === 0){ resolve(false); return; }
      const t0 = v.currentTime;
      v.playbackRate = -1;
      const tStart = performance.now();
      function probe(){
        const dt = performance.now() - tStart;
        const movedBack = v.currentTime < t0;
        resolve(movedBack);
      }
      setTimeout(probe, 250);
    });
  }

  function goForward(){
    cancelRAF(); rafMode = false;
    v.playbackRate = 1; v.play().catch(()=>{ /* ignore; tap overlay will help */ });
  }
  async function goReverse(){
    cancelRAF();
    const ok = await tryReversePlaybackRate();
    if(ok){
      rafMode = false; v.playbackRate = -1; v.play().catch(()=>{});
    } else {
      // Fallback: manual stepping
      rafMode = true; v.pause(); rafId = requestAnimationFrame(stepRAF);
    }
  }

  v.addEventListener('ended', ()=>{ dir=-1; goReverse(); });
  v.addEventListener('timeupdate', ()=>{
    if(dir<0 && !rafMode && v.currentTime <= 0.05){
      dir = 1; goForward();
    }
  });

  // Bootstrap once metadata is ready
  v.addEventListener('loadedmetadata', ()=>{
    v.currentTime = 0.01; dir = 1; goForward();
  });

  // Autoplay shim + tap-to-play
  function showTap(){ tap.style.display='block'; }
  function hideTap(){ tap.style.display='none'; }
  function tryPlayStart(){
    const p = v.play();
    if(p && p.catch) p.catch(()=> showTap());
  }
  if(document.readyState!=='loading') tryPlayStart();
  else document.addEventListener('DOMContentLoaded', tryPlayStart, {once:true});
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden && v.paused) tryPlayStart(); });
  window.addEventListener('pointerdown', ()=>{ if(v.paused){ hideTap(); tryPlayStart(); } }, {passive:true});

  // If the file truly fails (404), just keep the fog — no flash
  v.addEventListener('error', ()=>{ hideTap(); });
})();

/* ---------- init ---------- */
(function run(){
  sizeQuestion();
  buildMidNodes();
  layoutAll();
  window.addEventListener('resize', ()=>{ sizeQuestion(); layoutAll(); });
})();
</script>
</body>
</html>
