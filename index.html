<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>neurOrange ‚Äî Audio Player (Safari-safe, 25% scale)</title>
<style>
  :root { --nick:#FF6600; --nick2:#FF3B00; --berg-a:#ffeca7; --berg-b:#ffd45c; }
  html,body{height:100%;margin:0}
  /* Black so screen isn‚Äôt white if your page/video is still loading */
  body{background:#000;color:#fff;font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

  /* Dock bottom-left, scaled to 25% (half of previous .5). Allow overflow for sliders. */
  #dock{
    position:fixed;left:calc(12px + env(safe-area-inset-left));bottom:calc(12px + env(safe-area-inset-bottom));
    z-index:2147483647;display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:999px;
    background:linear-gradient(135deg,var(--nick),var(--nick2));color:#fff;border:1px solid rgba(0,0,0,.35);
    box-shadow:0 8px 20px rgba(255,102,0,.32);-webkit-user-select:none;user-select:none;
    transform:scale(.25);transform-origin:left bottom;overflow:visible; /* ‚üµ important */
  }
  #dock.collapsed .hideable{display:none!important}

  /* Toggle bubble */
  .bubble{position:relative;width:46px;height:46px;border:none;background:transparent;cursor:pointer;padding:0;outline:0}
  .bubble::before{content:"";position:absolute;inset:-2px;border-radius:999px;background:linear-gradient(135deg,var(--nick),var(--nick2));box-shadow:0 6px 16px rgba(0,0,0,.35)}
  .bubble .inner{position:absolute;inset:5px;border-radius:999px;background:radial-gradient(60% 60% at 35% 25%,#fff6c2 0%,var(--berg-a) 40%,var(--berg-b) 100%)}
  .bubble .glyph{position:relative;z-index:2;font-size:22px;line-height:46px;display:block;text-align:center}

  /* Orbs */
  .orb{width:42px;height:42px;border-radius:999px;display:grid;place-items:center;font-size:20px;font-weight:900;
       background:rgba(0,0,0,.18);border:1px solid rgba(0,0,0,.35);cursor:pointer;position:relative}
  .glyph{pointer-events:none}

  /* Volume popover centered above emoji. Very high z-index so it sits above everything. */
  .ad-wrap{position:relative}
  .ad-vol{
    position:absolute;bottom:58px;left:50%;transform:translateX(-50%);
    width:44px;padding:8px 6px;border-radius:12px;background:rgba(22,22,22,.92);
    border:1px solid rgba(255,255,255,.2);box-shadow:0 10px 24px rgba(0,0,0,.45);
    display:none;z-index:999999;
  }
  .ad-vol.visible{display:block}
  .ad-vol label{color:#fff;font-size:11px;opacity:.8;text-align:center;margin-bottom:6px;display:block}
  .ad-vol input[type="range"]{writing-mode:bt-lr;-webkit-appearance:slider-vertical;width:30px;height:110px;background:transparent;margin:0 auto}
  .ad-vol input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:#FF6600;border:1px solid rgba(0,0,0,.35);box-shadow:0 1px 4px rgba(0,0,0,.35)}
  .ad-vol input[type="range"]::-webkit-slider-runnable-track{width:6px;background:#ddd;border-radius:999px;border:0}
  .ad-vol input[type="range"]::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:#FF6600;border:1px solid rgba(0,0,0,.35)}
  .ad-vol input[type="range"]::-moz-range-track{width:6px;background:#ddd;border-radius:999px;border:0}

  #startOverlay{display:none!important} /* legacy */
</style>
</head>
<body>

  <!-- AUDIO elements (WebAudio GainNodes handle volume for Safari) -->
  <audio id="a_sparkle" loop preload="metadata" playsinline>
    <source src="tracks/sparkle.mp3" type="audio/mpeg" /><source src="tracks/sparkle.m4a" type="audio/mp4" />
  </audio>
  <audio id="a_orange" loop preload="metadata" playsinline>
    <source src="tracks/orange.mp3" type="audio/mpeg" /><source src="tracks/orange.m4a" type="audio/mp4" />
  </audio>
  <audio id="a_autumn" loop preload="metadata" playsinline>
    <source src="tracks/autumn.mp3" type="audio/mpeg" /><source src="tracks/autumn.m4a" type="audio/mp4" />
  </audio>
  <audio id="a_storm" loop preload="metadata" playsinline>
    <source src="tracks/storm.mp3" type="audio/mpeg" /><source src="tracks/storm.m4a" type="audio/mp4" />
  </audio>

  <!-- DOCK -->
  <div id="dock" class="collapsed" role="group" aria-label="Audio controls">
    <!-- Toggle -->
    <button id="b_toggle" class="bubble" aria-label="Toggle"><span class="inner"></span><span class="glyph">üü°</span></button>
    <!-- Stop: orange square -->
    <button id="b_stop" class="orb" aria-label="Stop / Reset"><span class="glyph">üüß</span></button>

    <!-- Sparkle -->
    <div class="hideable ad-wrap">
      <button id="b_sparkle" class="orb" aria-label="Sparkle"><span class="glyph">üå±</span></button>
      <div class="ad-vol" data-for="sparkle"><label>‚ú®</label><input id="v_sparkle" type="range" min="0" max="1" step="0.01" value="0.75"/></div>
    </div>
    <!-- Orange -->
    <div class="hideable ad-wrap">
      <button id="b_orangeTr" class="orb" aria-label="Orange"><span class="glyph">üå±</span></button>
      <div class="ad-vol" data-for="orange"><label>üçä</label><input id="v_orange" type="range" min="0" max="1" step="0.01" value="0.75"/></div>
    </div>
    <!-- Autumn -->
    <div class="hideable ad-wrap">
      <button id="b_autumn" class="orb" aria-label="Autumn"><span class="glyph">üå±</span></button>
      <div class="ad-vol" data-for="autumn"><label>üçÇ</label><input id="v_autumn" type="range" min="0" max="1" step="0.01" value="0.75"/></div>
    </div>
    <!-- Storm (non-exclusive) -->
    <div class="hideable ad-wrap">
      <button id="b_storm" class="orb" aria-label="Storm"><span class="glyph">üå±</span></button>
      <div class="ad-vol" data-for="storm"><label>‚õàÔ∏è</label><input id="v_storm" type="range" min="0" max="1" step="0.01" value="0.75"/></div>
    </div>
  </div>

<script>
(() => {
  /* WebAudio gain nodes ‚Äî Safari-safe volume */
  let ctx, unlocked=false;
  const AudioCtx = window.AudioContext || window.webkitAudioContext;

  const tracks = [
    { id:'sparkle', emoji:'‚ú®', el:document.getElementById('a_sparkle'), btn:document.getElementById('b_sparkle'), volUI:document.getElementById('v_sparkle'), exclusive:true },
    { id:'orange',  emoji:'üçä', el:document.getElementById('a_orange'),  btn:document.getElementById('b_orangeTr'), volUI:document.getElementById('v_orange'),  exclusive:true },
    { id:'autumn',  emoji:'üçÇ', el:document.getElementById('a_autumn'),  btn:document.getElementById('b_autumn'),  volUI:document.getElementById('v_autumn'),  exclusive:true },
    { id:'storm',   emoji:'‚õàÔ∏è', el:document.getElementById('a_storm'),   btn:document.getElementById('b_storm'),   volUI:document.getElementById('v_storm'),   exclusive:false }
  ];

  const BOOST = { sparkle:1.6, storm:2.2, orange:1.0, autumn:1.0 };   // gentle boosts; capped to 1.0
  const BASE  = 0.75;                                                 // overall -25%

  function ensureCtx(){
    if (!ctx){ ctx = new AudioCtx(); }
    tracks.forEach(t=>{
      if (!t.src){
        t.src  = ctx.createMediaElementSource(t.el);
        t.gain = ctx.createGain();
        t.src.connect(t.gain).connect(ctx.destination);
        t.el.volume = 1.0; // element full; gain node controls loudness
        applyGain(t, true);
      }
    });
  }
  function setGlyph(btn, symbol){ const g=btn.querySelector('.glyph'); if(g) g.textContent = symbol; }
  function applyGain(t, fromUI=false){
    const u = t.volUI ? parseFloat(t.volUI.value || BASE) : BASE;
    const boosted = Math.min(1, u * (BOOST[t.id] || 1));
    if (t.gain) t.gain.gain.value = boosted;
    if (!fromUI && t.volUI) t.volUI.value = boosted;
  }
  function showSliderFor(id, show){
    const pop = document.querySelector(`.ad-vol[data-for="${id}"]`);
    if (!pop) return;
    if (show) pop.classList.add('visible'); else pop.classList.remove('visible');
  }
  function hideAllSliders(){ document.querySelectorAll('.ad-vol.visible').forEach(p=>p.classList.remove('visible')); }

  async function startTrack(t, showSlider=true){
    ensureCtx(); await ctx.resume();
    if (t.exclusive){ tracks.forEach(x=>{ if (x!==t && x.exclusive && !x.el.paused) stopTrack(x); }); }
    try { t.el.currentTime = 0; } catch(_){}
    applyGain(t, true);
    try{
      await t.el.play();
      setGlyph(t.btn, t.emoji);
      if (showSlider){ hideAllSliders(); showSliderFor(t.id, true); }
    }catch(e){ setGlyph(t.btn,'üå±'); }
  }
  function stopTrack(t){
    try { t.el.pause(); } catch(_){}
    setGlyph(t.btn,'üå±');
    showSliderFor(t.id, false);
  }

  const dock      = document.getElementById('dock');
  const btnToggle = document.getElementById('b_toggle');
  const btnStop   = document.getElementById('b_stop');

  // Button bindings
  tracks.forEach(t=>{
    // init gains to BASE (0.75)
    applyGain(t, true);

    t.btn.addEventListener('click', async ()=>{
      if (!unlocked){ ensureCtx(); await ctx.resume(); unlocked=true; }
      if (t.el.paused) startTrack(t, true); else stopTrack(t);
    }, {passive:true});

    if (t.volUI){ t.volUI.addEventListener('input', ()=> applyGain(t, true), {passive:true}); }
    t.el.addEventListener('ended', ()=> setGlyph(t.btn,'üå±'));
    t.el.addEventListener('pause',  ()=> { if (!t.el.ended) setGlyph(t.btn,'üå±'); });
  });

  // Tray toggle
  btnToggle.addEventListener('click', ()=>{
    dock.classList.toggle('collapsed');
    if (!dock.classList.contains('collapsed')) hideAllSliders();
  }, {passive:true});

  // Stop all
  btnStop.addEventListener('click', ()=>{
    tracks.forEach(stopTrack);
    dock.classList.add('collapsed');
  }, {passive:true});

  // Front-page neurOrange -> start Sparkle at EXACT 50%
  const startOrange = document.getElementById('startOrange');
  if (startOrange){
    startOrange.addEventListener('click', async ()=>{
      ensureCtx(); await ctx.resume(); unlocked=true;
      dock.classList.remove('collapsed');
      const sparkle = tracks.find(x=>x.id==='sparkle');
      if (sparkle){
        if (sparkle.volUI) sparkle.volUI.value = "0.50";
        applyGain(sparkle, true);
        startTrack(sparkle, false);
      }
    }, {once:true, passive:true});
  }

  // iOS unlock on first gesture
  function unlockOnce(){
    window.removeEventListener('pointerdown', unlockOnce, true);
    ensureCtx(); ctx.resume().then(()=>{ unlocked=true; });
    // Prime elements so play() is allowed later
    tracks.forEach(t=>{ try{const p=t.el.play(); p&&p.then(()=>{t.el.pause(); t.el.currentTime=0;}).catch(()=>{});}catch(_){}} );
  }
  window.addEventListener('pointerdown', unlockOnce, {once:true, capture:true, passive:true});
})();
</script>
</body>
</html>
