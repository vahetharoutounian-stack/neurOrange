<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="color-scheme" content="dark" />
<meta name="theme-color" content="#000000" />
<title>neurOrange ‚Äî Home</title>

<style>
  :root{
    --bergamot:#FFA64D;  /* soft golden glow */
    --pure:#FFA500;
    --nick:#FF6600;      /* Nickelodeon */
    --after:#F9751F;     /* Afterimage */
    --gap-deg:3;
    --inner-thick:34px;  /* recomputed in JS */
    --outer-thick-mult:2.2;
    --emoji-font:18px;
    --glow:0 0 10px #000, 0 0 18px #000;
  }

  *{box-sizing:border-box}
  html,body{margin:0;min-height:100%;background:#000;color:#fff;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;-webkit-font-smoothing:antialiased;overflow:hidden}

  /* === Splash: press the orange to start === */
  #intro{position:fixed;inset:0;background:#000;display:grid;place-items:center;z-index:9999;opacity:1;pointer-events:auto;transition:opacity 900ms ease}
  #intro.hidden{opacity:0;pointer-events:none}
  .intro-stack{display:grid;justify-items:center;gap:1rem}
  #startOrange{font-size:clamp(110px,30vw,240px);line-height:1;user-select:none;cursor:pointer;filter:drop-shadow(0 0 26px rgba(0,0,0,.65)) drop-shadow(0 0 50px rgba(255,165,0,.25));transition:transform .12s ease}
  #startOrange:active{transform:scale(.98)}
  .intro-title{font-weight:900;letter-spacing:.14em;user-select:none;font-size:clamp(18px,6.2vw,44px);color:var(--bergamot);text-shadow:0 0 10px rgba(255,166,77,.55), 0 0 22px rgba(255,165,0,.35);animation:titlePulse 2.2s ease-in-out infinite}
  @keyframes titlePulse{0%{color:var(--bergamot)}50%{color:var(--pure)}100%{color:var(--bergamot)}}

  /* === Stage === */
  #phone{position:fixed;inset:0;display:grid;place-items:center}
  #canvas{position:relative;width:100%;height:100%;overflow:hidden;background:#000}
  #brandBar{position:absolute;left:0;right:0;top:10px;display:flex;justify-content:center;z-index:6;filter:drop-shadow(var(--glow))}
  #brand{font-weight:900;letter-spacing:.12em;font-size:clamp(18px,5vw,32px);color:#FFA500}

  /* background (video optional; fog always on) */
  #bgLayer{position:absolute;inset:0;z-index:1}
  #bgVideo{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity .4s ease}
  .fogWrap{position:absolute;inset:-30%;z-index:0;pointer-events:none;-webkit-mask-image:radial-gradient(circle at 50% 50%, rgba(0,0,0,1) 62%, rgba(0,0,0,0) 100%);mask-image:radial-gradient(circle at 50% 50%, rgba(0,0,0,1) 62%, rgba(0,0,0,0) 100%)}
  .fog{position:absolute;inset:0;mix-blend-mode:screen;filter:blur(60px) saturate(120%);background:
     radial-gradient(28% 22% at 20% 30%, var(--nick) 0 55%, transparent 60%),
     radial-gradient(28% 24% at 80% 40%, var(--nick) 0 55%, transparent 60%),
     radial-gradient(30% 22% at 40% 70%, var(--nick) 0 55%, transparent 60%);animation:fog1 26s linear infinite alternate;opacity:.62}
  @keyframes fog1{0%{transform:translate(0,0) scale(1)}100%{transform:translate(-3%,-4%) scale(1.08)}}

  #focus{position:absolute;inset:0;display:grid;place-items:center;z-index:2}

  /* start shrunk & centered; grow on start */
  .wrapCenter{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) scale(1);will-change:transform,opacity}
  .preGrow{transform:translate(-50%,-50%) scale(.05);opacity:0}
  .grow{animation:ringGrow var(--growDur,3600ms) cubic-bezier(.17,.9,.24,1.08) forwards;opacity:0}
  #innerWrap.grow {--growDur:3600ms;animation-delay:0ms}
  #midWrap.grow   {--growDur:4200ms;animation-delay:200ms}
  #outerWrap.grow {--growDur:4600ms;animation-delay:350ms}
  #emojiWrapA.grow{--growDur:4000ms;animation-delay:500ms}
  #emojiWrapB.grow{--growDur:4400ms;animation-delay:650ms}
  @keyframes ringGrow{0%{transform:translate(-50%,-50%) scale(.05) rotate(0deg);opacity:0}60%{transform:translate(-50%,-50%) scale(1.10) rotate(45deg);opacity:1}100%{transform:translate(-50%,-50%) scale(1.00) rotate(0deg);opacity:1}}

  .spin{position:absolute;inset:0}
  .halo{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);border-radius:50%;background:radial-gradient(closest-side, rgba(0,0,0,.35), rgba(0,0,0,0));filter:blur(10px);pointer-events:none;z-index:-1}

  /* center prompt */
  #question{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) scale(1);display:grid;place-items:center;background:#000;color:#fff;border-radius:50%;border:none;z-index:5;filter:drop-shadow(var(--glow));padding:.4rem .6rem;user-select:none;animation:breathe 7s ease-in-out infinite}
  @keyframes breathe{0%,100%{transform:translate(-50%,-50%) scale(1.00)}50%{transform:translate(-50%,-50%) scale(1.02)}}
  #questionText{font-weight:900;font-style:italic;text-align:center;font-size:clamp(16px,3.6vw,22px);line-height:1.15;margin:0;display:inline-block;transform-origin:50% 50%;animation:colorPulse 5.5s ease-in-out infinite}
  @keyframes colorPulse{0%{color:#fff;text-shadow:0 0 6px rgba(255,255,255,.35)}33%{color:var(--bergamot)}66%{color:#FFA500}100%{color:#fff}}

  /* rings rotate continuously */
  #innerSVG,#outerSVG{transform-box:fill-box;transform-origin:50% 50%;animation:spinCW 60s linear infinite}
  #outerSVG{animation-duration:70s}
  @keyframes spinCW{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}

  /* emoji rings (optional) */
  #emojiWrapA,#emojiWrapB{z-index:4}
  .emojiRing{position:absolute;inset:0}
  .emojiSpin{position:absolute;inset:0;animation:spinCCW var(--dur,60s) linear infinite}
  @keyframes spinCCW{from{transform:rotate(0deg)}to{transform:rotate(-360deg)}}
  .emoji{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:var(--emoji-font);border:none;border-radius:10px;background:rgba(0,0,0,.08);padding:1px 3px;filter:drop-shadow(0 0 8px #000) drop-shadow(0 0 14px #000)}

  /* ghost flicker (outer ring) */
  .ghost-wedge{fill:var(--c0);animation:ghostFlick var(--dur,12s) ease-in-out infinite;animation-delay:var(--delay,0s);cursor:pointer}
  @keyframes ghostFlick{0%,88%,100%{fill:var(--c0)}89%,90%{fill:var(--c1)}}

  /* painting ring */
  #midWrap{z-index:8}
  #midSpin{animation:spinCCW 56s linear infinite;filter:drop-shadow(var(--glow))}
  #midRing{position:absolute;inset:0}
  .mnode{position:absolute;top:50%;left:50%;border-radius:50%;transform:translate(-50%,-50%);background:#111;overflow:hidden;border:1.5px solid #000;filter:drop-shadow(var(--glow));cursor:pointer}
  .mnode.withCloud::before{content:"";position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:calc(100% + 16px);height:calc(100% + 16px);border-radius:inherit;background:radial-gradient(closest-side, rgba(0,0,0,.38), rgba(0,0,0,0));filter:blur(8px);pointer-events:none}
  .mnode img{width:100%;height:100%;object-fit:cover;display:block;border-radius:50%;animation:upright 56s linear infinite;transform-origin:center;backface-visibility:hidden}
  @keyframes upright{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}

  /* bottom nav ‚Äî simple */
  .bottomNav{position:fixed;left:0;right:0;bottom:calc(env(safe-area-inset-bottom) + 10px);z-index:8;display:flex;gap:10px;justify-content:space-between;padding:0 12px}
  .navBtn{flex:1;text-align:center;font-weight:900;padding:10px 8px;border-radius:12px;border:1px solid rgba(0,0,0,.45);color:#140a00;user-select:none;-webkit-user-select:none;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.35);text-decoration:none;display:inline-block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:clamp(12px, 3.2vw, 14px);line-height:1.05}
  .navLeft{background:linear-gradient(180deg,#F4C430,#E69B20)}
  .navMid{background:linear-gradient(180deg,#FF8E00,#FF6A13)}
  .navRight{background:linear-gradient(180deg,#FFA500,#FE5000)}

  /* === TRANSITION OVERLAY (fade-to-black + randomized quote) === */
  #transition{position:fixed;inset:0;background:#000;z-index:10050;display:grid;place-items:center;opacity:0;pointer-events:none;transition:opacity 600ms ease}
  #transition.show{opacity:1;pointer-events:auto}
  #quoteBox{max-width:min(92vw,720px);padding:2.2rem 1.6rem;text-align:center}
  #quoteText{font-weight:900;font-style:italic;letter-spacing:.02em;font-size:clamp(18px,5.2vw,30px);line-height:1.25;color:#ddd;text-shadow:0 0 10px rgba(0,0,0,.8)}
  .Oword{animation: orangeHue 2.8s ease-in-out infinite alternate, orangeGlow 2.8s ease-in-out infinite alternate}
  @keyframes orangeHue{0%{color:var(--nick)}100%{color:var(--after)}}
  @keyframes orangeGlow{0%{text-shadow:0 0 10px rgba(255,166,77,.55),0 0 18px rgba(255,102,0,.35)}100%{text-shadow:0 0 12px rgba(255,166,77,.75),0 0 26px rgba(255,102,0,.55)}}
</style>
</head>
<body>

<!-- Splash -->
<div id="intro">
  <div class="intro-stack">
    <div id="startOrange" aria-label="Start">üçä</div>
    <div class="intro-title">neurOrange</div>
  </div>
</div>

<div id="phone">
  <div id="canvas">
    <div id="brandBar"><div id="brand">neurOrange</div></div>

    <div id="bgLayer">
      <!-- Optional background video: place your file in assets/placeholder.mp4 -->
      <video id="bgVideo" muted playsinline webkit-playsinline preload="auto" loop>
        <source src="assets/placeholder.mp4" type="video/mp4" />
      </video>
      <div class="fogWrap"><div class="fog"></div></div>
    </div>

    <div id="focus">
      <!-- Outer ring -->
      <div id="outerWrap" class="wrapCenter preGrow">
        <svg id="outerSVG" width="0" height="0" viewBox="0 0 1000 1000" style="position:absolute; inset:0"></svg>
        <div class="halo" id="outerHalo"></div>
      </div>

      <!-- Inner ring -->
      <div id="innerWrap" class="wrapCenter preGrow">
        <svg id="innerSVG" width="0" height="0" viewBox="0 0 1000 1000" style="position:absolute; inset:0"></svg>
        <div class="halo" id="innerHalo"></div>
      </div>

      <!-- Comets layer -->
      <div id="cometField" class="wrapCenter preGrow"></div>

      <!-- Painting ring -->
      <div id="midWrap" class="wrapCenter preGrow">
        <div id="midSpin" class="spin"><div id="midRing"></div></div>
      </div>

      <!-- Emoji rings (optional visuals) -->
      <div id="emojiWrapA" class="wrapCenter preGrow"><div class="emojiSpin" style="--dur:56s"><div id="emojiRingA" class="emojiRing"></div></div></div>
      <div id="emojiWrapB" class="wrapCenter preGrow"><div class="emojiSpin" style="--dur:82s; transform: rotate(-12deg)"><div id="emojiRingB" class="emojiRing"></div></div></div>

      <!-- Center prompt -->
      <div id="question"><div id="questionText">What are you<br/>feeling?</div></div>
    </div>

    <!-- Bottom nav -->
    <div class="bottomNav">
      <a class="navBtn navLeft"  href="https://vahetharoutounian-stack.github.io/neurOrangeV3/">Color Library</a>
      <a class="navBtn navMid"   href="https://vahetharoutounian-stack.github.io/neurOrangeV2/">Art Gallery</a>
      <a class="navBtn navRight" href="https://vahetharoutounian-stack.github.io/neurOrangeV3/#step=3">Illusion Lab</a>
    </div>
  </div>
</div>

<!-- Transition overlay -->
<div id="transition"><div id="quoteBox"><div id="quoteText"></div></div></div>

<!-- === AUDIO PLAYER START (fixed, 2√ó size, no üí´, Safari-safe) === -->
<style>
  :root { --nick2:#FF3B00; --berg-a:#ffeca7; --berg-b:#ffd45c; }
  /* Player tray (fixed & non-draggable) */
  #dock{
    position:fixed;left:calc(12px + env(safe-area-inset-left));bottom:calc(12px + env(safe-area-inset-bottom));
    z-index:2147483647;display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:999px;
    background:linear-gradient(135deg,var(--nick),var(--nick2));color:#fff;border:1px solid rgba(0,0,0,.35);
    box-shadow:0 8px 20px rgba(255,102,0,0.32);transform:scale(.5);transform-origin:left bottom;overflow:visible;touch-action:none
  }
  #dock *{ -webkit-user-drag:none; user-drag:none; }
  #dock.collapsed .hideable{display:none!important}
  .bubble{position:relative;width:46px;height:46px;border:0;background:transparent;cursor:pointer;padding:0;outline:0}
  .bubble::before{content:"";position:absolute;inset:-2px;border-radius:999px;background:linear-gradient(135deg,var(--nick),var(--nick2));box-shadow:0 6px 16px rgba(0,0,0,.35)}
  .bubble .inner{position:absolute;inset:5px;border-radius:999px;background:radial-gradient(60% 60% at 35% 25%,#fff6c2 0%,var(--berg-a) 40%,var(--berg-b) 100%)}
  .bubble .glyph{position:relative;z-index:2;font-size:22px;line-height:46px;text-align:center}
  .orb{width:42px;height:42px;border-radius:999px;display:grid;place-items:center;font-size:20px;font-weight:900;background:rgba(0,0,0,.18);border:1px solid rgba(0,0,0,.35);cursor:pointer;position:relative;touch-action:manipulation}
  .glyph{pointer-events:none}
  .ad-wrap{position:relative}
  .ad-vol{position:absolute;bottom:58px;left:50%;transform:translateX(-50%);width:44px;padding:8px 6px;border-radius:12px;background:rgba(22,22,22,.92);border:1px solid rgba(255,255,255,.2);box-shadow:0 10px 24px rgba(0,0,0,.45);display:none;z-index:999999}
  .ad-vol.visible{display:block}
  .ad-vol label{color:#fff;font-size:11px;opacity:.8;text-align:center;margin-bottom:6px;display:block}
  .ad-vol input[type=range]{writing-mode:bt-lr;-webkit-appearance:slider-vertical;width:30px;height:110px;background:transparent;margin:0 auto}
  .ad-vol input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:#FF6600;border:1px solid rgba(0,0,0,.35);box-shadow:0 1px 4px rgba(0,0,0,.35)}
  .ad-vol input[type=range]::-webkit-slider-runnable-track{width:6px;background:#ddd;border-radius:999px;border:0}
  .ad-vol input[type=range]::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:#FF6600;border:1px solid rgba(0,0,0,.35)}
  .ad-vol input[type=range]::-moz-range-track{width:6px;background:#ddd;border-radius:999px;border:0}
</style>

<!-- Audio sources for WebAudio -->
<audio id="a_sparkle" loop preload="metadata" playsinline>
  <source src="tracks/sparkle.mp3" type="audio/mpeg" />
  <source src="tracks/sparkle.m4a" type="audio/mp4" />
</audio>
<audio id="a_orange" loop preload="metadata" playsinline>
  <source src="tracks/orange.mp3" type="audio/mpeg" />
  <source src="tracks/orange.m4a" type="audio/mp4" />
</audio>
<audio id="a_autumn" loop preload="metadata" playsinline>
  <source src="tracks/autumn.mp3" type="audio/mpeg" />
  <source src="tracks/autumn.m4a" type="audio/mp4" />
</audio>
<audio id="a_storm" loop preload="metadata" playsinline>
  <source src="tracks/storm.mp3" type="audio/mpeg" />
  <source src="tracks/storm.m4a" type="audio/mp4" />
</audio>

<!-- Dock -->
<div id="dock" class="collapsed" role="group" aria-label="Audio controls">
  <button id="b_toggle" class="bubble" aria-label="Toggle"><span class="inner"></span><span class="glyph">üü°</span></button>
  <button id="b_stop"   class="orb" aria-label="Stop / Reset"><span class="glyph">üüß</span></button>
  <div class="hideable ad-wrap">
    <button id="b_sparkle" class="orb" aria-label="Sparkle"><span class="glyph">üå±</span></button>
    <div class="ad-vol" data-for="sparkle"><label>‚ú®</label><input id="v_sparkle" type="range" min="0" max="1" step="0.01" value="0.75"/></div>
  </div>
  <div class="hideable ad-wrap">
    <button id="b_orangeTr" class="orb" aria-label="Orange"><span class="glyph">üå±</span></button>
    <div class="ad-vol" data-for="orange"><label>üçä</label><input id="v_orange" type="range" min="0" max="1" step="0.01" value="0.75"/></div>
  </div>
  <div class="hideable ad-wrap">
    <button id="b_autumn" class="orb" aria-label="Autumn"><span class="glyph">üå±</span></button>
    <div class="ad-vol" data-for="autumn"><label>üçÇ</label><input id="v_autumn" type="range" min="0" max="1" step="0.01" value="0.75"/></div>
  </div>
  <div class="hideable ad-wrap">
    <button id="b_storm"  class="orb" aria-label="Storm"><span class="glyph">üå±</span></button>
    <div class="ad-vol" data-for="storm"><label>‚õàÔ∏è</label><input id="v_storm" type="range" min="0" max="1" step="0.01" value="0.75"/></div>
  </div>
</div>
<!-- === AUDIO PLAYER END === -->

<script>
/* ========= Quotes (exact six) ========= */
const QUOTES_RAW = [
  "‚ÄúIt‚Äôs funny how the colors of the real world only seem really real when you viddy them on the screen.‚Äù ‚Äî A Clockwork Orange (1971)",
  "‚ÄúOrange is the happiest color.‚Äù ‚Äî Frank Sinatra",
  "‚ÄúThere is no blue without yellow and without orange.‚Äù ‚Äî Vincent Van Gogh",
  "‚ÄúThe orange tree took time to create this masterpiece.‚Äù ‚Äî Thich Nhat Hanh",
  "‚ÄúIf the real world is orange juice, then art is like orange juice concentrate.‚Äù ‚Äî Martin Mull",
  "‚ÄúIn a world full of yellows and reds, dare to be orange.‚Äù"
];
function decorateOrangeWords(str){return str.replace(/orange/gi,m=>`<span class="Oword">${m}</span>`)}
function randIndex(len){try{const a=new Uint32Array(1);crypto.getRandomValues(a);return a[0]%len}catch{return Math.floor(Math.random()*len)}}
function pickQuoteHTML(){return decorateOrangeWords(QUOTES_RAW[randIndex(QUOTES_RAW.length)])}

/* ========= Helpers ========= */
function $(id){return document.getElementById(id)}
function $$(sel){return Array.from(document.querySelectorAll(sel))}
function hexNorm(h){return (h||'').replace(/^#/,'').toUpperCase()}

/* ========= Center text rotation (1 rpm bounded) ========= */
(function(){
  const t=$('questionText'), b=$('question');
  const w=t.offsetWidth,h=t.offsetHeight,pad=Math.max(6,Math.round(Math.max(w,h)*0.20));
  const D=Math.ceil(Math.max(w,h)+pad*2); b.style.width=D+'px'; b.style.height=D+'px';
  let angle=0, dir=Math.random()<0.5?1:-1, speed=360/60, change=3+Math.random()*5, last=performance.now();
  function step(now){const dt=(now-last)/1000;last=now;angle+=dir*speed*dt;if(angle>45){angle=45;dir=-1}if(angle<-45){angle=-45;dir=1}change-=dt;if(change<=0){if(Math.random()<0.35)dir*=-1;change=3+Math.random()*5}t.style.transform=`rotate(${angle.toFixed(3)}deg)`;requestAnimationFrame(step)}
  requestAnimationFrame(step);
})();

/* ========= Wedges & Rings ========= */
function wedgePath(cx,cy,r0,r1,a0Deg,a1Deg){const R=d=>d*Math.PI/180;const a0=R(a0Deg),a1=R(a1Deg);const P=(r,a)=>({x:cx+r*Math.cos(a),y:cy+r*Math.sin(a)});const A=P(r1,a0),B=P(r1,a1),C=P(r0,a1),D=P(r0,a0);const large=(a1Deg-a0Deg)>180?1:0;return `M ${D.x} ${D.y} L ${A.x} ${A.y} A ${r1} ${r1} 0 ${large} 1 ${B.x} ${B.y} L ${C.x} ${C.y} A ${r0} ${r0} 0 ${large} 0 ${D.x} ${D.y} Z`}

const BRIGHT=[{hex:"#FE5000"},{hex:"#FFA500"},{hex:"#FF8E00"},{hex:"#FF6600"},{hex:"#FF6A00"},{hex:"#FF9400"},{hex:"#F28500"},{hex:"#FF7F24"},{hex:"#ED9121"},{hex:"#FFBF00"},{hex:"#FF5E00"},{hex:"#FF6A13"}];
const GHOSTS=["#B36019","#F9751F","#F6B76F","#D2B379","#E3AC47","#F88E10","#C18514","#DE9513","#92752D","#F0CE85","#FCBA45","#D99621","#E8C569","#F0B85F","#D2B265"];

function drawRing(svgEl,sizePx,r0px,r1px,colors,gapDeg,onClickHex){
  svgEl.setAttribute('viewBox','0 0 1000 1000');svgEl.style.width=sizePx+'px';svgEl.style.height=sizePx+'px';
  const k=1000/sizePx,r0=Math.max(2,r0px*k),r1=r1px*k,gap=Number(gapDeg)||0,n=colors.length,slice=360/n;svgEl.innerHTML='';
  for(let i=0;i<n;i++){const hex=(typeof colors[i]==='string')?colors[i]:colors[i].hex;const a0=i*slice,a1=(i+1)*slice-gap;const p=document.createElementNS('http://www.w3.org/2000/svg','path');p.setAttribute('d',wedgePath(500,500,r0,r1,a0,a1));p.setAttribute('fill',hex);p.setAttribute('stroke','rgba(0,0,0,.18)');p.setAttribute('stroke-width','1');if(onClickHex)p.addEventListener('click',()=>onClickHex(hex),{passive:true});svgEl.appendChild(p)}}

function opponent(hex){hex=hex.replace('#','');if(hex.length===3)hex=hex.split('').map(c=>c+c).join('');const r=parseInt(hex.slice(0,2),16),g=parseInt(hex.slice(2,4),16),b=parseInt(hex.slice(4,6),16);const {h,s,l}=rgbToHsl(r,g,b);const opp=(h+180)%360;const {r:R,g:G,b:B}=hslToRgb(opp,s,l);return '#'+[R,G,B].map(v=>v.toString(16).padStart(2,'0')).join('')}
function rgbToHsl(r,g,b){r/=255;g/=255;b/=255;const mx=Math.max(r,g,b),mn=Math.min(r,g,b);let h,s,l=(mx+mn)/2;if(mx===mn){h=s=0}else{const d=mx-mn;s=l>0.5?d/(2-mx-mn):d/(mx+mn);switch(mx){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break}h/=6}return {h:h*360,s,l}}
function hslToRgb(h,s,l){h/=360;let r,g,b;if(s===0){r=g=b=l}else{const hue2rgb=(p,q,t)=>{if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p};const q=l<0.5?l*(1+s):l+s-l*s,p=2*l-q;r=hue2rgb(p,q,h+1/3);g=hue2rgb(p,q,h);b=hue2rgb(p,q,h-1/3)}return {r:Math.round(r*255),g:Math.round(g*255),b:Math.round(b*255)}}

function layoutRings(){
  const innerSVG=$('innerSVG'),outerSVG=$('outerSVG'),innerWrap=$('innerWrap'),outerWrap=$('outerWrap'),midRing=$('midRing');
  const W=innerWidth,H=innerHeight,S=Math.min(W,H);
  document.documentElement.style.setProperty('--emoji-font',Math.round(W*0.036)+'px');
  const innerD=Math.round(S*0.58),innerThick=Math.max(16,Math.round(innerD*0.12));
  innerWrap.style.width=innerD+'px';innerWrap.style.height=innerD+'px';
  const innerOuter=innerD/2,innerInner=Math.max(2,innerOuter-innerThick*2);
  drawRing(innerSVG,innerD,innerInner,innerOuter,BRIGHT,3,(hex)=>transitionTo(`https://vahetharoutounian-stack.github.io/neurOrangeV3/#step=2&cat=standards&hex=${hexNorm(hex)}`));

  const nodeD=Math.round(innerThick*0.85*5.25*0.82),margin=2,midR=Math.max(0,(W/2)-(nodeD/2)-margin);
  const N=6,step=2*Math.PI/N;
  if(!midRing.children.length){for(let i=1;i<=6;i++){const n=document.createElement('div');n.className='mnode withCloud';n.addEventListener('click',()=>transitionTo(`https://vahetharoutounian-stack.github.io/neurOrangeV2/#painting=${i}`),{passive:true});const img=new Image();img.alt='Painting '+i;img.src=`assets/paintings/${i}.jpg`;n.appendChild(img);midRing.appendChild(n)}}
  Array.from(midRing.children).forEach((n,i)=>{const a=i*step,x=Math.cos(a)*midR,y=Math.sin(a)*midR;n.style.width=nodeD+'px';n.style.height=nodeD+'px';n.style.transform=`translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`});

  const outerInnerR=midR+nodeD/2+margin,outerThick=innerThick*2.2,outerOuterR=Math.max(outerInnerR+outerThick,W/2+8),outD=Math.round(outerOuterR*2);
  outerWrap.style.width=outD+'px';outerWrap.style.height=outD+'px';
  // ghost ring with flicker
  const ghosts=GHOSTS.map(c=>({base:c,opp:opponent(c)}));
  outerSVG.setAttribute('viewBox','0 0 1000 1000');outerSVG.style.width=outD+'px';outerSVG.style.height=outD+'px';
  const k=1000/outD,r0=Math.max(2,outerInnerR*k),r1=outerOuterR*k,gap=3,nG=ghosts.length,slice=360/nG;outerSVG.innerHTML='';
  for(let i=0;i<nG;i++){const {base,opp}=ghosts[i];const a0=i*slice,a1=(i+1)*slice-gap;const p=document.createElementNS('http://www.w3.org/2000/svg','path');p.setAttribute('d',wedgePath(500,500,r0,r1,a0,a1));p.classList.add('ghost-wedge');p.style.setProperty('--c0',base);p.style.setProperty('--c1',opp);const dur=10+Math.random()*6,phase=Math.random()*dur;p.style.setProperty('--dur',dur.toFixed(2)+'s');p.style.setProperty('--delay',(-phase).toFixed(2)+'s');p.setAttribute('stroke','rgba(0,0,0,.18)');p.setAttribute('stroke-width','1');p.addEventListener('click',()=>transitionTo(`https://vahetharoutounian-stack.github.io/neurOrangeV3/#step=3&cat=ghosts&hex=${hexNorm(base)}`),{passive:true});outerSVG.appendChild(p)}
}

/* ========= Comets (asteroids) ========= */
function startComets(){
  const field=$('cometField'); field.innerHTML='';
  const cycleLen=5; let cometCount=0;
  function spawn(){
    cometCount++; const idx=((cometCount-1)%cycleLen)+1;
    const W=innerWidth,H=innerHeight,run=Math.max(W,H)+400,theta=Math.random()*Math.PI*2;
    const kinds=['straight','offcenter','curved']; const kind=kinds[Math.floor(Math.random()*kinds.length)];
    const n={x:-Math.sin(theta),y:Math.cos(theta)},dur=5+Math.random()*3; let P0,P1,C; const center={x:0,y:0};
    if(kind==='straight'){P0={x:center.x-Math.cos(theta)*run/2,y:center.y-Math.sin(theta)*run/2};P1={x:center.x+Math.cos(theta)*run/2,y:center.y-Math.sin(theta)*run/2}}
    else if(kind==='offcenter'){const d=(Math.random()*0.35+0.15)*(W/2),sh={x:n.x*(Math.random()<0.5?-d:d),y:n.y*(Math.random()<0.5?-d:d)};P0={x:center.x-Math.cos(theta)*run/2+sh.x,y:center.y-Math.sin(theta)*run/2+sh.y};P1={x:center.x+Math.cos(theta)*run/2+sh.x,y:center.y-Math.sin(theta)*run/2+sh.y}}
    else{P0={x:center.x-Math.cos(theta)*run/2,y:center.y-Math.sin(theta)*run/2};P1={x:center.x+Math.cos(theta)*run/2,y:center.y-Math.sin(theta)*run/2};const bend=(Math.random()*0.5+0.3)*(W/2);C={x:center.x+n.x*(Math.random()<0.5?-bend:bend),y:center.y+n.y*(Math.random()<0.5?-bend:bend)}}
    const comet=document.createElement('div'); comet.style.cssText='position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);pointer-events:none;filter:drop-shadow(0 0 8px #000)'; const stack=document.createElement('div'); stack.style.cssText='position:relative;font-size:22px';
    const top=document.createElement('div');
    // first in cycle has nothing, 4th has üå± (sprout), 5th has üåπ else üçä
    if(idx===1){top.textContent='';} else if(idx===5){top.textContent='üåπ';} else if(idx===4){top.textContent='üå±';} else {top.textContent='üçä';}
    const tail=document.createElement('div'); tail.textContent='‚òÑÔ∏è'; tail.style.marginLeft='-6px';
    stack.appendChild(top); stack.appendChild(tail); comet.appendChild(stack); field.appendChild(comet);
    let t0=null; function lerp(a,b,t){return a+(b-a)*t}
    function draw(now){ if(!t0)t0=now; const u=Math.min(1,(now-t0)/(dur*1000)); let x,y;
      if(C){const one=1-u;x=one*one*P0.x+2*one*u*C.x+u*u*P1.x;y=one*one*P0.y+2*one*u*C.y+u*u*P1.y}
      else{x=lerp(P0.x,P1.x,u);y=lerp(P0.y,P1.y,u)}
      comet.style.transform=`translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
      if(u<1)requestAnimationFrame(draw); else comet.remove()}
    requestAnimationFrame(draw);
  }
  (function loop(){spawn(); setTimeout(loop, 7000 + Math.random()*5000);})();
}

/* ========= Transition overlay logic ========= */
let transitioning=false;
function transitionTo(url){
  if(transitioning) return; transitioning=true;
  const tr=$('transition'),qt=$('quoteText'); qt.innerHTML=pickQuoteHTML(); tr.classList.add('show');
  setTimeout(()=>{ location.href = url; }, 2200);
}
window.addEventListener('pageshow', ()=>{ $('transition').classList.remove('show'); transitioning=false; try{crypto.getRandomValues(new Uint32Array(1))}catch{} });

/* ========= Layout boot ========= */
function layoutAll(){ layoutRings(); }

/* ========= Audio Player (WebAudio Gain) ========= */
(function(){
  let ctx, unlocked=false;
  const AudioCtx=window.AudioContext||window.webkitAudioContext;
  const tracks=[
    {id:'sparkle',emoji:'‚ú®',el:$('a_sparkle'),btn:$('b_sparkle'),volUI:$('v_sparkle'),exclusive:true},
    {id:'orange', emoji:'üçä',el:$('a_orange'), btn:$('b_orangeTr'),volUI:$('v_orange'), exclusive:true},
    {id:'autumn', emoji:'üçÇ',el:$('a_autumn'), btn:$('b_autumn'), volUI:$('v_autumn'), exclusive:true},
    {id:'storm',  emoji:'‚õàÔ∏è',el:$('a_storm'),  btn:$('b_storm'),  volUI:$('v_storm'),  exclusive:false}
  ];
  const BOOST={sparkle:1.6,storm:2.2,orange:1.0,autumn:1.0}, BASE=0.75;
  function ensureCtx(){ if(!ctx){ctx=new AudioCtx()} tracks.forEach(t=>{ if(!t.src){ t.src=ctx.createMediaElementSource(t.el); t.gain=ctx.createGain(); t.src.connect(t.gain).connect(ctx.destination); t.el.volume=1.0; applyGain(t,true);} }) }
  function setGlyph(btn,s){const g=btn.querySelector('.glyph'); if(g) g.textContent=s}
  function applyGain(t,fromUI=false){const u=t.volUI?parseFloat(t.volUI.value||BASE):BASE; const v=Math.min(1,u*(BOOST[t.id]||1)); if(t.gain)t.gain.gain.value=v; if(!fromUI&&t.volUI)t.volUI.value=v}
  function showSliderFor(id,show){const pop=document.querySelector(`.ad-vol[data-for="${id}"]`); if(pop) pop.classList.toggle('visible',show)}
  function hideAllSliders(){document.querySelectorAll('.ad-vol.visible').forEach(p=>p.classList.remove('visible'))}
  async function startTrack(t,showSlider=true){ ensureCtx(); await ctx.resume(); if(t.exclusive){tracks.forEach(x=>{ if(x!==t&&x.exclusive&&!x.el.paused) stopTrack(x) })} try{t.el.currentTime=0}catch{} applyGain(t,true); try{ await t.el.play(); setGlyph(t.btn,t.emoji); if(showSlider){ hideAllSliders(); showSliderFor(t.id,true) } }catch{ setGlyph(t.btn,'üå±') } }
  function stopTrack(t){ try{t.el.pause()}catch{} setGlyph(t.btn,'üå±'); showSliderFor(t.id,false) }

  const dock=$('dock'); const bToggle=$('b_toggle'); const bStop=$('b_stop');
  bToggle.addEventListener('click',()=>{ dock.classList.toggle('collapsed'); hideAllSliders(); },{passive:true});
  bStop.addEventListener('click',()=>{ tracks.forEach(stopTrack); hideAllSliders(); dock.classList.add('collapsed'); },{passive:true});

  tracks.forEach(t=>{ applyGain(t,true); t.btn.addEventListener('click',async()=>{ if(!unlocked){ensureCtx();await ctx.resume();unlocked=true} if(t.el.paused) startTrack(t,true); else stopTrack(t) },{passive:true}); if(t.volUI) t.volUI.addEventListener('input',()=>applyGain(t,true),{passive:true}); t.el.addEventListener('ended',()=>setGlyph(t.btn,'üå±')); t.el.addEventListener('pause',()=>{if(!t.el.ended)setGlyph(t.btn,'üå±')}); });

  // Splash tap: start everything (grow-out, video, comets, audio)
  const startOrange=$('startOrange');
  if(startOrange){
    startOrange.addEventListener('click', async ()=>{
      // hide splash
      $('intro').classList.add('hidden');
      setTimeout(()=>{$('intro').remove()},900);

      // play & reveal background video (if present)
      const v=$('bgVideo'); if(v){const show=()=>v.style.opacity=1; v.addEventListener('loadeddata',show,{once:true}); v.addEventListener('playing',show,{once:true}); try{ const p=v.play(); p&&p.catch(()=>{}) }catch{}}

      // run grow-out + comets
      ['innerWrap','midWrap','outerWrap','emojiWrapA','emojiWrapB','cometField'].forEach(id=>{const el=$(id); if(el){el.classList.remove('grow'); el.classList.add('preGrow'); requestAnimationFrame(()=> el.classList.add('grow'))}});
      startComets();

      // start audio immediately (Sparkle at EXACT 50%)
      ensureCtx(); await ctx.resume(); unlocked=true;
      dock.classList.remove('collapsed');
      const sp=tracks.find(x=>x.id==='sparkle');
      if(sp){ if(sp.volUI) sp.volUI.value="0.50"; applyGain(sp,true); startTrack(sp,false); } // slider closed on auto-start
    },{once:true,passive:true});
  }

  // unlock on first gesture (iOS)
  function unlockOnce(){window.removeEventListener('pointerdown',unlockOnce,true); ensureCtx(); ctx.resume().then(()=>{unlocked=true}); tracks.forEach(t=>{try{const p=t.el.play(); p&&p.then(()=>{t.el.pause();t.el.currentTime=0}).catch(()=>{})}catch{}})}
  window.addEventListener('pointerdown', unlockOnce, {once:true,capture:true,passive:true});
})();
</script>
</body>
</html>
