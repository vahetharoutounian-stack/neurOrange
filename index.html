<!-- === AUDIO PLAYER START (fixed, 2√ó size, no üí´, Safari-safe) === -->
<style>
  /* All styles scoped under #dock so nothing outside is affected */
  #dock{
    position:fixed;
    left:calc(12px + env(safe-area-inset-left));
    bottom:calc(12px + env(safe-area-inset-bottom));
    z-index:2147483647;
    display:flex; align-items:center; gap:12px;
    padding:12px 14px; border-radius:999px;
    /* Nickelodeon orange gradient; no reliance on page variables */
    background:linear-gradient(135deg,#FF6600,#FF3B00);
    color:#fff;
    border:1px solid rgba(0,0,0,.35);
    box-shadow:0 8px 20px rgba(255,102,0,0.32);
    transform:scale(.5);            /* 2√ó size */
    transform-origin:left bottom;
    overflow:visible;               /* sliders pop outside */
    touch-action:none;              /* no dragging */
  }
  /* Lock tray (no pointer events) until splash starts, so taps go to splash */
  #dock.locked { pointer-events:none !important; }
  #dock *{ -webkit-user-drag:none; user-drag:none; }
  #dock.collapsed .hideable{ display:none !important; }

  /* Toggle bubble */
  #dock .bubble{ position:relative; width:46px; height:46px; border:0; background:transparent; cursor:pointer; padding:0; outline:0; }
  #dock .bubble::before{ content:""; position:absolute; inset:-2px; border-radius:999px;
    background:linear-gradient(135deg,#FF6600,#FF3B00); box-shadow:0 6px 16px rgba(0,0,0,.35); }
  #dock .bubble .inner{ position:absolute; inset:5px; border-radius:999px;
    background:radial-gradient(60% 60% at 35% 25%,#fff6c2 0%,#ffeca7 40%,#ffd45c 100%); }
  #dock .bubble .glyph{ position:relative; z-index:2; font-size:22px; line-height:46px; text-align:center; }

  /* Orbs */
  #dock .orb{
    width:42px; height:42px; border-radius:999px; display:grid; place-items:center;
    font-size:20px; font-weight:900; background:rgba(0,0,0,.18); border:1px solid rgba(0,0,0,.35);
    cursor:pointer; position:relative; touch-action:manipulation;
  }
  #dock .glyph{ pointer-events:none; }

  /* Volume popovers ‚Äî centered above emoji */
  #dock .ad-wrap{ position:relative; }
  #dock .ad-vol{
    position:absolute; bottom:58px; left:50%; transform:translateX(-50%);
    width:44px; padding:8px 6px; border-radius:12px;
    background:rgba(22,22,22,.92); border:1px solid rgba(255,255,255,.2);
    box-shadow:0 10px 24px rgba(0,0,0,.45); display:none; z-index:999999;
  }
  #dock .ad-vol.visible{ display:block; }
  #dock .ad-vol label{ color:#fff; font-size:11px; opacity:.8; text-align:center; margin-bottom:6px; display:block; }
  #dock .ad-vol input[type=range]{ writing-mode:bt-lr; -webkit-appearance:slider-vertical; width:30px; height:110px; background:transparent; margin:0 auto; }
  #dock .ad-vol input[type=range]::-webkit-slider-thumb{ -webkit-appearance:none; width:18px; height:18px; border-radius:50%; background:#FF6600; border:1px solid rgba(0,0,0,.35); box-shadow:0 1px 4px rgba(0,0,0,.35) }
  #dock .ad-vol input[type=range]::-webkit-slider-runnable-track{ width:6px; background:#ddd; border-radius:999px; border:0; }
  #dock .ad-vol input[type=range]::-moz-range-thumb{ width:18px; height:18px; border-radius:50%; background:#FF6600; border:1px solid rgba(0,0,0,.35) }
  #dock .ad-vol input[type=range]::-moz-range-track{ width:6px; background:#ddd; border-radius:999px; border:0; }
</style>

<!-- Audio sources (element volume stays 1.0; GainNodes control loudness) -->
<audio id="a_sparkle" loop preload="metadata" playsinline>
  <source src="tracks/sparkle.mp3" type="audio/mpeg" />
  <source src="tracks/sparkle.m4a" type="audio/mp4" />
</audio>
<audio id="a_orange" loop preload="metadata" playsinline>
  <source src="tracks/orange.mp3" type="audio/mpeg" />
  <source src="tracks/orange.m4a" type="audio/mp4" />
</audio>
<audio id="a_autumn" loop preload="metadata" playsinline>
  <source src="tracks/autumn.mp3" type="audio/mpeg" />
  <source src="tracks/autumn.m4a" type="audio/mp4" />
</audio>
<audio id="a_storm" loop preload="metadata" playsinline>
  <source src="tracks/storm.mp3" type="audio/mpeg" />
  <source src="tracks/storm.m4a" type="audio/mp4" />
</audio>

<!-- Fixed, non-draggable tray -->
<div id="dock" class="locked collapsed" role="group" aria-label="Audio controls">
  <button id="b_toggle" class="bubble" aria-label="Toggle"><span class="inner"></span><span class="glyph">üü°</span></button>
  <button id="b_stop"   class="orb"    aria-label="Stop / Reset"><span class="glyph">üüß</span></button>

  <div class="hideable ad-wrap">
    <button id="b_sparkle" class="orb" aria-label="Sparkle"><span class="glyph">üå±</span></button>
    <div class="ad-vol" data-for="sparkle"><label>‚ú®</label><input id="v_sparkle" type="range" min="0" max="1" step="0.01" value="0.75"/></div>
  </div>

  <div class="hideable ad-wrap">
    <button id="b_orangeTr" class="orb" aria-label="Orange"><span class="glyph">üå±</span></button>
    <div class="ad-vol" data-for="orange"><label>üçä</label><input id="v_orange" type="range" min="0" max="1" step="0.01" value="0.75"/></div>
  </div>

  <div class="hideable ad-wrap">
    <button id="b_autumn" class="orb" aria-label="Autumn"><span class="glyph">üå±</span></button>
    <div class="ad-vol" data-for="autumn"><label>üçÇ</label><input id="v_autumn" type="range" min="0" max="1" step="0.01" value="0.75"/></div>
  </div>

  <div class="hideable ad-wrap">
    <button id="b_storm"  class="orb" aria-label="Storm"><span class="glyph">üå±</span></button>
    <div class="ad-vol" data-for="storm"><label>‚õàÔ∏è</label><input id="v_storm" type="range" min="0" max="1" step="0.01" value="0.75"/></div>
  </div>
</div>

<script>
/* ===================== Audio Player (namespaced; zero globals) ===================== */
(function(){
  let ctx, unlocked=false;
  const AudioCtx = window.AudioContext || window.webkitAudioContext;

  const tracks = [
    { id:'sparkle', emoji:'‚ú®', el:document.getElementById('a_sparkle'), btn:document.getElementById('b_sparkle'), volUI:document.getElementById('v_sparkle'), exclusive:true },
    { id:'orange',  emoji:'üçä', el:document.getElementById('a_orange'),  btn:document.getElementById('b_orangeTr'), volUI:document.getElementById('v_orange'),  exclusive:true },
    { id:'autumn',  emoji:'üçÇ', el:document.getElementById('a_autumn'),  btn:document.getElementById('b_autumn'),  volUI:document.getElementById('v_autumn'),  exclusive:true },
    { id:'storm',   emoji:'‚õàÔ∏è', el:document.getElementById('a_storm'),   btn:document.getElementById('b_storm'),   volUI:document.getElementById('v_storm'),   exclusive:false } // layers
  ];

  // -25% base volume + gentle per-track boosts (capped to 1.0)
  const BOOST = { sparkle:1.6, storm:2.2, orange:1.0, autumn:1.0 };
  const BASE  = 0.75;

  function ensureCtx(){
    if (!ctx){ ctx = new AudioCtx(); }
    tracks.forEach(t=>{
      if (!t.src){
        t.src  = ctx.createMediaElementSource(t.el);
        t.gain = ctx.createGain();
        t.src.connect(t.gain).connect(ctx.destination);
        t.el.volume = 1.0;          // element full; gain controls loudness
        applyGain(t, true);
      }
    });
  }
  function setGlyph(btn, symbol){ const g=btn.querySelector('.glyph'); if(g) g.textContent = symbol; }
  function applyGain(t, fromUI=false){
    const u = t.volUI ? parseFloat(t.volUI.value || BASE) : BASE;
    const boosted = Math.min(1, u * (BOOST[t.id] || 1));
    if (t.gain) t.gain.gain.value = boosted;                    // WebAudio gain
    if (!fromUI && t.volUI) t.volUI.value = boosted;
  }
  function showSliderFor(id, show){ const pop=document.querySelector(`.ad-vol[data-for="${id}"]`); if(pop) pop.classList.toggle('visible', show); }
  function hideAllSliders(){ document.querySelectorAll('.ad-vol.visible').forEach(p=>p.classList.remove('visible')); }

  async function startTrack(t, showSlider=true){
    ensureCtx(); await ctx.resume();
    if (t.exclusive){
      tracks.forEach(x => { if (x!==t && x.exclusive && !x.el.paused) stopTrack(x); });
    }
    try { t.el.currentTime = 0; } catch(_){}
    applyGain(t, true);
    try{
      await t.el.play();
      setGlyph(t.btn, t.emoji);
      if (showSlider){ hideAllSliders(); showSliderFor(t.id, true); }
    }catch{ setGlyph(t.btn, 'üå±'); }
  }
  function stopTrack(t){
    try { t.el.pause(); } catch(_){}
    setGlyph(t.btn, 'üå±');
    showSliderFor(t.id, false);
  }

  const dock      = document.getElementById('dock');
  const btnToggle = document.getElementById('b_toggle');
  const btnStop   = document.getElementById('b_stop');

  // Toggle tray ‚Äî sliders always close when opening/closing
  btnToggle.addEventListener('click', ()=>{
    dock.classList.toggle('collapsed');
    hideAllSliders();
  }, {passive:true});

  // Stop all
  btnStop.addEventListener('click', ()=>{
    tracks.forEach(stopTrack);
    hideAllSliders();
    dock.classList.add('collapsed');
  }, {passive:true});

  // Hook up each track
  tracks.forEach(t=>{
    applyGain(t, true); // init to BASE
    t.btn.addEventListener('click', async ()=>{
      if (!unlocked){ ensureCtx(); await ctx.resume(); unlocked = true; }
      if (t.el.paused) startTrack(t, true); else stopTrack(t);
    }, {passive:true});

    if (t.volUI) t.volUI.addEventListener('input', ()=> applyGain(t, true), {passive:true});
    t.el.addEventListener('ended', ()=> setGlyph(t.btn,'üå±'));
    t.el.addEventListener('pause',  ()=> { if (!t.el.ended) setGlyph(t.btn,'üå±'); });
  });

  // Start from the neurOrange splash emoji: Sparkle at EXACT 50%
  const startOrange = document.getElementById('startOrange');
  const introTap    = document.getElementById('introTap') || document.getElementById('intro'); // whole splash tap-safe
  const startNow = async (ev)=>{
    ev && ev.preventDefault && ev.preventDefault();

    // Unlock and show tray (but keep collapsed until user opens)
    dock.classList.remove('locked');

    // Ensure audio context + 50% sparkle immediately
    ensureCtx(); await ctx.resume(); unlocked = true;
    const sp = tracks.find(x=>x.id==='sparkle');
    if (sp){
      if (sp.volUI) sp.volUI.value = "0.50";
      applyGain(sp, true);
      startTrack(sp, false);  // slider closed on auto-start
    }

    // Remove listeners so it only runs once
    startOrange && startOrange.removeEventListener('click', startNow, true);
    introTap    && introTap.removeEventListener('click',   startNow, true);
    window.removeEventListener('pointerup', startNow, true);
    window.removeEventListener('touchend',  startNow, true);
  };

  // Bind multiple event types for reliability on iOS
  startOrange && startOrange.addEventListener('click', startNow, true);
  introTap    && introTap.addEventListener('click',   startNow, true);
  window.addEventListener('pointerup', startNow, {once:true, capture:true, passive:true});
  window.addEventListener('touchend',  startNow, {once:true, capture:true, passive:true});

  // iOS unlock fallback on first touch
  function unlockOnce(){
    window.removeEventListener('pointerdown', unlockOnce, true);
    ensureCtx(); ctx.resume().catch(()=>{}); // allow later
    // Prime each element for iOS gesture policy
    tracks.forEach(t=>{
      try{
        const p=t.el.play();
        p && p.then(()=>{ t.el.pause(); t.el.currentTime=0; }).catch(()=>{});
      }catch{}
    });
  }
  window.addEventListener('pointerdown', unlockOnce, {once:true, capture:true, passive:true});
})();
</script>
<!-- === AUDIO PLAYER END === -->
