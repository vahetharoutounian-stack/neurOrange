<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Orange Player â€” folder (iOS-safe)</title>
<style>
  :root { --nick:#FF6600; }
  html,body{height:100%}
  body{background:#0f0f11;color:#fff;font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0}
  #dock{
    position:fixed; left:calc(12px + env(safe-area-inset-left)); bottom:calc(12px + env(safe-area-inset-bottom));
    z-index:2147483647; display:flex; align-items:center; gap:12px;
    padding:12px 14px; border-radius:999px; background:var(--nick); color:#fff;
    border:1px solid rgba(0,0,0,.35); box-shadow:0 8px 20px rgba(255,102,0,.32);
    -webkit-user-select:none; user-select:none;
  }
  .orb{
    width:42px; height:42px; border-radius:999px; display:grid; place-items:center;
    font-size:20px; font-weight:900; background:rgba(0,0,0,.18);
    border:1px solid rgba(0,0,0,.35); cursor:pointer; position:relative;
  }
  .nub{ display:none }
  @media (min-width:720px){ .nub{ display:block; width:96px; accent-color:#fff; } }
  .badge{ position:absolute; right:-6px; top:-6px; font-size:12px; background:#111; border-radius:6px; padding:0 2px; }
  .glyph{ pointer-events:none }
  .hint{position:fixed; right:12px; bottom:12px; opacity:.7; font-size:12px}
</style>
</head>
<body>
  <!-- separate audio tags so tracks can overlap -->
  <audio id="a1" preload="metadata" playsinline></audio>
  <audio id="a2" preload="metadata" playsinline></audio>
  <audio id="a3" preload="metadata" playsinline></audio>

  <div id="dock" role="group" aria-label="Audio controls">
    <button id="b1" class="orb" aria-label="Track 1"><span class="glyph">ðŸŒ±</span><span id="e1" class="badge"></span></button>
    <input id="v1" class="nub" type="range" min="0" max="100" value="85" aria-label="Vol 1"/>
    <button id="b2" class="orb" aria-label="Track 2"><span class="glyph">ðŸŒ±</span><span id="e2" class="badge"></span></button>
    <input id="v2" class="nub" type="range" min="0" max="100" value="100" aria-label="Vol 2"/>
    <button id="b3" class="orb" aria-label="Track 3"><span class="glyph">ðŸŒ±</span><span id="e3" class="badge"></span></button>
    <input id="v3" class="nub" type="range" min="0" max="100" value="100" aria-label="Vol 3"/>
  </div>
  <div class="hint">Drop 01/02/03 in /tracks (mp3/m4a/aac/wav/ogg/mp4)</div>

<script>
(function(){
  const exts = ["mp3","m4a","aac","wav","ogg","mp4"]; // order we try
  const A1 = document.getElementById('a1'), B1 = document.getElementById('b1'), V1 = document.getElementById('v1'), E1 = document.getElementById('e1');
  const A2 = document.getElementById('a2'), B2 = document.getElementById('b2'), V2 = document.getElementById('v2'), E2 = document.getElementById('e2');
  const A3 = document.getElementById('a3'), B3 = document.getElementById('b3'), V3 = document.getElementById('v3'), E3 = document.getElementById('e3');

  const tracks = [
    { idx:1, a:A1, b:B1, v:V1, e:E1, emoji:"ðŸŠ", src:"", resolving:false, ready:false },
    { idx:2, a:A2, b:B2, v:V2, e:E2, emoji:"ðŸŸ ", src:"", resolving:false, ready:false },
    { idx:3, a:A3, b:B3, v:V3, e:E3, emoji:"âœ¨", src:"", resolving:false, ready:false }
  ];
  // real volumes on start; slider lies at 85% for track 1 until moved
  let t1Initialized = false;
  A1.volume = 0.10; A2.volume = 1.00; A3.volume = (+V3.value||100)/100;

  const seed = el => el.querySelector('.glyph').textContent = "ðŸŒ±";
  const playIcon = (el, g) => el.querySelector('.glyph').textContent = g;
  const badge = (el, msg) => { el.textContent = msg||""; if (msg) setTimeout(()=>{ el.textContent=""; }, 1500); };

  function waitReady(a, ms=1500){
    return new Promise(res=>{
      if (a.readyState >= 3) return res();
      let done=false;
      const finish=()=>{ if(done) return; done=true; a.removeEventListener('canplay',finish); a.removeEventListener('loadeddata',finish); res(); };
      a.addEventListener('canplay', finish, {once:true});
      a.addEventListener('loadeddata', finish, {once:true});
      setTimeout(finish, ms);
    });
  }

  async function resolveSrc(n){
    for (let i=0;i<exts.length;i++){
      const src = `tracks/0${n}.${exts[i]}`;
      const probe = new Audio();
      probe.preload = "auto";
      probe.src = src;
      const ok = await new Promise(r=>{
        let resolved=false, t=setTimeout(()=>{ if(!resolved){ resolved=true; cleanup(); r(false); } }, 1200);
        function cleanup(){ probe.removeEventListener('canplay', on); probe.removeEventListener('loadeddata', on); probe.removeEventListener('error', err); clearTimeout(t); }
        function on(){ if(!resolved){ resolved=true; cleanup(); r(true); } }
        function err(){ if(!resolved){ resolved=true; cleanup(); r(false); } }
        probe.addEventListener('canplay', on, {once:true});
        probe.addEventListener('loadeddata', on, {once:true});
        probe.addEventListener('error', err, {once:true});
        try{ probe.load(); }catch(_){}
      });
      if (ok) return src;
    }
    return "";
  }

  async function ensureResolved(t){
    if (t.src || t.resolving) return t.src;
    t.resolving = true;
    t.src = await resolveSrc(t.idx);
    t.resolving = false;
    if (!t.src) badge(t.e, `add 0${t.idx}`);
    return t.src;
  }

  async function start(t){
    if (t.idx === 1 && !t1Initialized){ t.a.volume = 0.10; V1.value = 85; t1Initialized = true; }
    if (t.idx === 2){ t.a.volume = 1.00; V2.value = 100; }
    if (t.idx === 3){ t.a.volume = (+V3.value||100)/100; }

    const src = await ensureResolved(t);
    if (!src) return;
    t.a.src = src;
    t.a.muted = false;
    playIcon(t.b, t.emoji);
    try { await waitReady(t.a); await t.a.play(); } catch(_) {}
  }

  function stop(t){
    try { t.a.pause(); } catch(_) {}
    seed(t.b);
  }

  // iOS unlock that doesnâ€™t break first press
  (function unlockIOS(){
    let unlocked=false, unlocking=false;
    function unlock(){
      if (unlocked || unlocking) return; unlocking = true;
      const prev = tracks.map(t=>({muted:t.a.muted, vol:t.a.volume}));
      tracks.forEach(t=>{ t.a.muted = true; t.a.volume = 0; });
      Promise.all(tracks.map(t=>{
        try { t.a.play().catch(()=>{}); } catch(_){}
        return new Promise(r=>setTimeout(r,60));
      })).then(()=>{
        tracks.forEach((t,i)=>{ try{ t.a.pause(); }catch(_){ } t.a.currentTime=0; t.a.muted=prev[i].muted; t.a.volume=prev[i].vol; });
        unlocked = true; unlocking = false;
        window.removeEventListener('pointerdown', unlock, true);
        window.removeEventListener('touchend',   unlock, true);
        window.removeEventListener('click',      unlock, true);
      });
    }
    window.addEventListener('pointerdown', unlock, true);
    window.addEventListener('touchend',   unlock, true);
    window.addEventListener('click',      unlock, true);
  })();

  tracks.forEach(t=>{
    t.b.addEventListener('click', ()=> t.a.paused ? start(t) : stop(t), {passive:true});
    t.v.addEventListener('input', ()=>{ t.a.volume = Math.max(0, Math.min(1, (+t.v.value||0)/100)); }, {passive:true});
    t.a.addEventListener('ended', ()=> seed(t.b));
    t.a.addEventListener('pause', ()=> { if (!t.a.ended) seed(t.b); });
    seed(t.b);
  });
})();
</script>
</body>
</html>
